# Migrating AMQ Streams from Openshift 3.11 to 4.7

[quote, AMQS Product Docs]
AMQ Streams simplifies the process of running Apache Kafka in an OpenShift cluster.

In this post I will show how to migrate an AMQ Stream cluster between OCP environments(ie: OCP3.11 to OCP4.8) using MirrorMaker2; a Kafka component used to replicate data between two or more active Kafka clusters, within or across data centers. 

We will begin with an overview of the two clusters(kafka-source and kafka-target), the components deployed, then show how to set up AMQ Stream v1.8, Prometheus(metrics collection), and Grafana(monitoring and alerting). All these components are deployed via a single helm chart with possibility of selectively installing specific resources(amqs, mirrormaker, grafana). 

## Environment Overview

This guide uses two namespaces within the same Openshift cluster to mimic cross OCP deployments migration. The approach would be roughly the same if for instance we were looking to migrate a Strimzi cluster from OCP3 to OCP4. An obvious change would be using external routes when referencing source brokers; rather than services in our case.

### Architecture

image::images/architecture.png[setup-architecture]

### Components, CRDs deployed

We will be deploying AMQ Streams v1.8 for this demo.

* CRDs
** to grant OCP the capability to read and understand Strimzi resource manifests;
* Cluster operator to manage the Kafka cluster
** watches over the strimzi cluster components for change reconciliation
* Kafka (including ZooKeeper, Entity Operator, Kafka Exporter, and Cruise Control)
** https://access.redhat.com/documentation/en-us/red_hat_amq/2021.q3/html-single/using_amq_streams_on_openshift/index#type-KafkaSpec-reference[Follow this link for more]
* KafkaMirrorMaker2
** handles cluster mirroring activities;
** deployed on the target cluster
* Prometheus
** used for metrics collection
* Grafana -- v7.5.11
** used for displaying metrics on dashboards and alerting
** deployed in both clusters;
** we could use PrometheusRule and Alertmanager to send alerts as well.

## Implementation

This guide will be deployed on a 2 nodes Openshift 4.8 cluster.

IMPORTANT: You need _cluster-admin_ role on the cluster to execute most the tasks described in this guide.

### Cluster info, Tools used

* 2 nodes OpenShift 4.8 Cluster
** The ideal setup should be at least 3 worker nodes.
* kubernetes v1.21.0
* oc v4.8.2
* AMQ Streams v1.8
* Grafana v7.5.11
* projects/namespaces: cluster-source, cluster-target
* helm v3.6.2

Because this demo uses multiple components to setup the entire cluster, we will use the concept of sub-chart whereby we have modules for:
* cluster-operator -- managing the cluster
* kafka -- setting up the kafka cluster components
* strimzi-monitoring -- observe and alerts on the kafka cluster
* subscribers -- they act as producers and consumers

### Part1: Setting up the source kafka cluster

#### Enable user workload monitoring

* Check if user-workload monitoring is enabled

[source,bash]
----
oc -n openshift-user-workload-monitoring get pod
----

** If enabled, the output should look like below table

[source,text]
----
NAME                                   READY   STATUS        RESTARTS   AGE
prometheus-operator-6f7b748d5b-t7nbg   2/2     Running       0          3h
prometheus-user-workload-0             4/4     Running       1          3h
prometheus-user-workload-1             4/4     Running       1          3h
thanos-ruler-user-workload-0           3/3     Running       0          3h
thanos-ruler-user-workload-1           3/3     Running       0          3h
----

* If output don't match the table above, apply the user-workload-monitoring sub-chart
+
[source,bash]
----
# Install the cluster-operator sub-chart
helm install user-workload-monitoring amq-streams-chart/charts/user-workload-monitoring --namespace cluster-source
# list pods
oc -n openshift-user-workload-monitoring get pod
----
+
** Output should look like above table.
* https://docs.openshift.com/container-platform/4.8/monitoring/enabling-monitoring-for-user-defined-projects.html[Click here for more].

#### Deploy the cluster operator
** The cluster-operator CRDs are setup within a subchart named cluster-operator
** workdir: parent directory of the root helm chart
** you could add --dry-run to preview actions taken by helm
[source,bash]
----
# Install the cluster-operator sub-chart
helm install cluster-operator amq-streams-chart/charts/cluster-operator --namespace cluster-source
# list pods
oc -n cluster-source get pods -l 'helm.sh/chart=cluster-operator'
----
* The output should look like below table
[source,text]
----
Put output  here
----

#### Deploy Kafka
** The cluster-operator must be deployed first
** The kafka components are declared within a sub-chart named kafka-components.

[source,bash]
----
# Apply the kafka sub-chart to deploy kafka and its components
helm install strimzi-cluster amq-streams-chart/charts/kafka --namespace cluster-source
# list pods
oc -n cluster-source get pods -l 'helm.sh/chart=kafka'
----
* The output should look like below table
[source,text]
----
Put output  here
----

#### Deploy monitoring resources for dashboards and alerts

*Prerequisites:*

* User workload monitoring must be enabled before attempting to deploy the monitoring resources for the strimzi cluster. 
* I have added the workload monitoring enabler configmap in the kafka subchart. 

[source,bash]
----
# Apply the strimzi-monitoring sub-chart
helm install strimzi-monitoring amq-streams-chart/charts/strimzi-monitoring --namespace cluster-source
# list pods
oc -n cluster-source get pods -l 'helm.sh/chart=strimzi-monitoring'
----
* The output should look like below table
[source,text]
----
Put output  here
----







